---
title: 基于stdarg.h的可变参数函数的用法
id: 1
categories:
  - C/C++
date: 2015-11-19 00:02:55
tags:
  - C/C++
---

.在开始学习C语言的函数的时候，我们就知道函数的参数个数应该是在函数声明的时候就指定的，这一点我们没有任何疑问。但是不知道大家有没有注意到我们的printf()函数，他的函数参数理论上并不是确定的，而是随着匹配字符串中的格式控制符的个数控制的。其实当时也没有注意到这一点，到是最近，偶然间看到了[《嗨翻C语言》](http://book.douban.com/subject/25703412/)这本书，这里就详细讲解了这种可变参数函数的实现原理，今天考试间隙就顺带学习了一下，其实就是一种方法，知道了就晓得了，也是非常的简单。

## 头文件

这个用法需要引用一些宏，这些宏定义在C标准库“stdarg.h”中，(当然C++中就是“cstdarg”了)。

## 函数声明
```
int fun(int arg1,int arg2, ...){
//foo
}
```
这里可以用普通传参方法传入几个固定参数，一般情况下会有个表示可变参数的个数(否则函数也不晓得你到底传给了他啥)，最后表示可变参数部分的是三个连续的点，注意中间不能有空格。我们传入的可变参数就是在这里的。

## 具体用法

这里主要涉及到va_list类型，va_start()、va_arg()、va_end()这几个函数。

va_list 可以理解为以链表的形式保存那些可变参数的一个数据类型（既然是链表，当然是可变的了）。

void va_start(va_list ap , int len); 接受两个参数，一个是上面的那个东西，还有一个表示数据的数目。目测可以理解为是自动收集传给本函数的可变参数，并连带他的数目，将信息赋给 va_list 。

type va_arg(va_list ap , type ); 接受两个参数，一个是va_list，另一个是保存的数据的类型。因为在调用参数的时候，编译器不会检查实际输入的是什么参数，所以需要适时的指定，并以那个类型返回。注意，这时候在va_list中的某个指针会指向下一个元素，所以下一次调用时输出的值就是下一个元素。在这一点上用法类似于iterator。

void va_end(va_list ap);最后清理这个va_list.

## 演示源码
```cpp
#include<stdarg.h>
#include<stdio.h>
void print(int arg,...){
	va_list ap;
	va_start(ap, arg);
	for (int i = 0; i < arg; i++){
		printf("%d ", va_arg(ap,int));
	}
	va_end(ap);
}
int main(){
	print(4, 1, 2, 3, 4);
}
```
结果自然是输出 1 2 3 4。

## 说明

虽然看上去效果很酷，但是实际上据说这种用法的确很不安全，容易造成运行错误，所以还是尽量要少用。这种类似的问题如果能用重载或者类来解决的话还是少用可变参数函数吧。